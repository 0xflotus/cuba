<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Cuba by soveran</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Cuba</h1>
        <p>Rum based microframework for web development.</p>

        <p class="view"><a href="https://github.com/soveran/cuba">View the Project on GitHub <small>soveran/cuba</small></a></p>


        <ul>
          <li><a href="https://github.com/soveran/cuba/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/soveran/cuba/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/soveran/cuba">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="viva-cuba" class="anchor" href="#viva-cuba" aria-hidden="true"><span class="octicon octicon-link"></span></a>Viva Cuba!</h1>

<p>Cuba is a Ruby microframework for web development.</p>

<h2>
<a id="community" class="anchor" href="#community" aria-hidden="true"><span class="octicon octicon-link"></span></a>Community</h2>

<p>Meet us on IRC: #cuba.rb on <a href="http://freenode.net/">freenode.net</a>.</p>

<h2>
<a id="description" class="anchor" href="#description" aria-hidden="true"><span class="octicon octicon-link"></span></a>Description</h2>

<p>Cuba is a microframework for web development originally inspired
by <a href="http://github.com/chneukirchen/rum">Rum</a>, a tiny but powerful mapper for <a href="http://github.com/rack/rack">Rack</a>
applications.</p>

<p>It integrates many templates via <a href="http://github.com/rtomayko/tilt">Tilt</a>, and testing via
<a href="http://github.com/djanowski/cutest">Cutest</a> and <a href="http://github.com/jnicklas/capybara">Capybara</a>.</p>

<h2>
<a id="guide" class="anchor" href="#guide" aria-hidden="true"><span class="octicon octicon-link"></span></a>Guide</h2>

<p>There's a book called <a href="http://theguidetocuba.io">The Guide to Cuba</a> that explains how
to build web applications by following a minimalistic approach. It
is recommended reading for anyone trying to learn the basics of
Cuba and other related tools.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<div class="highlight highlight-text-shell-session"><pre>$ <span class="pl-s1">gem install cuba</span></pre></div>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<p>Here's a simple application:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c"># cat hello_world.rb</span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/safe<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.use <span class="pl-c1">Rack</span>::<span class="pl-c1">Session</span>::<span class="pl-c1">Cookie</span>, <span class="pl-c1">:secret</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>__a_very_long_string__<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">Cuba</span>::<span class="pl-c1">Safe</span>

<span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on get <span class="pl-k">do</span>
    on <span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
      res.write <span class="pl-s"><span class="pl-pds">"</span>Hello world!<span class="pl-pds">"</span></span>
    <span class="pl-k">end</span>

    on root <span class="pl-k">do</span>
      res.redirect <span class="pl-s"><span class="pl-pds">"</span>/hello<span class="pl-pds">"</span></span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>And the test file:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c"># cat hello_world_test.rb</span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/test<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>./hello_world<span class="pl-pds">"</span></span>

scope <span class="pl-k">do</span>
  test <span class="pl-s"><span class="pl-pds">"</span>Homepage<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    get <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>

    follow_redirect!

    assert_equal <span class="pl-s"><span class="pl-pds">"</span>Hello world!<span class="pl-pds">"</span></span>, last_response.body
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>To run it, you can create a <code>config.ru</code> file:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c"># cat config.ru</span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>./hello_world<span class="pl-pds">"</span></span>

run <span class="pl-c1">Cuba</span></pre></div>

<p>You can now run <code>rackup</code> and enjoy what you have just created.</p>

<h2>
<a id="matchers" class="anchor" href="#matchers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Matchers</h2>

<p>Here's an example showcasing how different matchers work:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/safe<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.use <span class="pl-c1">Rack</span>::<span class="pl-c1">Session</span>::<span class="pl-c1">Cookie</span>, <span class="pl-c1">:secret</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>__a_very_long_string__<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">Cuba</span>::<span class="pl-c1">Safe</span>

<span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>

  <span class="pl-c"># only GET requests</span>
  on get <span class="pl-k">do</span>

    <span class="pl-c"># /</span>
    on root <span class="pl-k">do</span>
      res.write <span class="pl-s"><span class="pl-pds">"</span>Home<span class="pl-pds">"</span></span>
    <span class="pl-k">end</span>

    <span class="pl-c"># /about</span>
    on <span class="pl-s"><span class="pl-pds">"</span>about<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
      res.write <span class="pl-s"><span class="pl-pds">"</span>About<span class="pl-pds">"</span></span>
    <span class="pl-k">end</span>

    <span class="pl-c"># /styles/basic.css</span>
    on <span class="pl-s"><span class="pl-pds">"</span>styles<span class="pl-pds">"</span></span>, extension(<span class="pl-s"><span class="pl-pds">"</span>css<span class="pl-pds">"</span></span>) <span class="pl-k">do </span>|<span class="pl-smi">file</span>|
      res.write <span class="pl-s"><span class="pl-pds">"</span>Filename: <span class="pl-pse">#{</span><span class="pl-s1">file</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span> <span class="pl-c">#=&gt; "Filename: basic"</span>
    <span class="pl-k">end</span>

    <span class="pl-c"># /post/2011/02/16/hello</span>
    on <span class="pl-s"><span class="pl-pds">"</span>post/:y/:m/:d/:slug<span class="pl-pds">"</span></span> <span class="pl-k">do </span>|<span class="pl-smi">y</span>, <span class="pl-smi">m</span>, <span class="pl-smi">d</span>, <span class="pl-smi">slug</span>|
      res.write <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pse">#{</span><span class="pl-s1">y</span><span class="pl-pse"><span class="pl-s1">}</span></span>-<span class="pl-pse">#{</span><span class="pl-s1">m</span><span class="pl-pse"><span class="pl-s1">}</span></span>-<span class="pl-pse">#{</span><span class="pl-s1">d</span><span class="pl-pse"><span class="pl-s1">}</span></span> <span class="pl-pse">#{</span><span class="pl-s1">slug</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span> <span class="pl-c">#=&gt; "2011-02-16 hello"</span>
    <span class="pl-k">end</span>

    <span class="pl-c"># /username/foobar</span>
    on <span class="pl-s"><span class="pl-pds">"</span>username/:username<span class="pl-pds">"</span></span> <span class="pl-k">do </span>|<span class="pl-smi">username</span>|
      user <span class="pl-k">=</span> <span class="pl-c1">User</span>.find_by_username(username) <span class="pl-c"># username == "foobar"</span>

      <span class="pl-c"># /username/foobar/posts</span>
      on <span class="pl-s"><span class="pl-pds">"</span>posts<span class="pl-pds">"</span></span> <span class="pl-k">do</span>

        <span class="pl-c"># You can access `user` here, because the `on` blocks</span>
        <span class="pl-c"># are closures.</span>
        res.write <span class="pl-s"><span class="pl-pds">"</span>Total Posts: <span class="pl-pse">#{</span><span class="pl-s1">user.posts.size</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span> <span class="pl-c">#=&gt; "Total Posts: 6"</span>
      <span class="pl-k">end</span>

      <span class="pl-c"># /username/foobar/following</span>
      on <span class="pl-s"><span class="pl-pds">"</span>following<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
        res.write user.following.size <span class="pl-c">#=&gt; "1301"</span>
      <span class="pl-k">end</span>
    <span class="pl-k">end</span>

    <span class="pl-c"># /search?q=barbaz</span>
    on <span class="pl-s"><span class="pl-pds">"</span>search<span class="pl-pds">"</span></span>, param(<span class="pl-s"><span class="pl-pds">"</span>q<span class="pl-pds">"</span></span>) <span class="pl-k">do </span>|<span class="pl-smi">query</span>|
      res.write <span class="pl-s"><span class="pl-pds">"</span>Searched for <span class="pl-pse">#{</span><span class="pl-s1">query</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span> <span class="pl-c">#=&gt; "Searched for barbaz"</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>

  <span class="pl-c"># only POST requests</span>
  on post <span class="pl-k">do</span>
    on <span class="pl-s"><span class="pl-pds">"</span>login<span class="pl-pds">"</span></span> <span class="pl-k">do</span>

      <span class="pl-c"># POST /login, user: foo, pass: baz</span>
      on param(<span class="pl-s"><span class="pl-pds">"</span>user<span class="pl-pds">"</span></span>), param(<span class="pl-s"><span class="pl-pds">"</span>pass<span class="pl-pds">"</span></span>) <span class="pl-k">do </span>|<span class="pl-smi">user</span>, <span class="pl-smi">pass</span>|
        res.write <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pse">#{</span><span class="pl-s1">user</span><span class="pl-pse"><span class="pl-s1">}</span></span>:<span class="pl-pse">#{</span><span class="pl-s1">pass</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span> <span class="pl-c">#=&gt; "foo:baz"</span>
      <span class="pl-k">end</span>

      <span class="pl-c"># If the params `user` and `pass` are not provided, this</span>
      <span class="pl-c"># block will get executed.</span>
      on <span class="pl-c1">true</span> <span class="pl-k">do</span>
        res.write <span class="pl-s"><span class="pl-pds">"</span>You need to provide user and pass!<span class="pl-pds">"</span></span>
      <span class="pl-k">end</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h2>
<a id="status-codes" class="anchor" href="#status-codes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Status codes</h2>

<p>If you don't assign a status code and you don't write to the <code>res</code>
object, the status will be set as <code>404</code>.</p>

<p>For example:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on get <span class="pl-k">do</span>
    on <span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
      res.write <span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">"</span></span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c"># Requests:</span>
<span class="pl-c">#</span>
<span class="pl-c"># GET /            # 404</span>
<span class="pl-c"># GET /hello       # 200</span>
<span class="pl-c"># GET /hello/world # 200</span></pre></div>

<p>As you can see, as soon as something was written to the response,
the status code was changed to 200.</p>

<p>If you want to match just "hello", but not "hello/world", you can do
as follows:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on get <span class="pl-k">do</span>
    on <span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
      on root <span class="pl-k">do</span>
        res.write <span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">"</span></span>
      <span class="pl-k">end</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c"># Requests:</span>
<span class="pl-c">#</span>
<span class="pl-c"># GET /            # 404</span>
<span class="pl-c"># GET /hello       # 200</span>
<span class="pl-c"># GET /hello/world # 404</span></pre></div>

<p>You can also use a regular expression to match the end of line:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on get <span class="pl-k">do</span>
    on <span class="pl-k">/</span>hello\<span class="pl-k">/</span><span class="pl-c1">?\z</span><span class="pl-k">/</span> <span class="pl-k">do</span>
      res.write <span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">"</span></span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c"># Requests:</span>
<span class="pl-c">#</span>
<span class="pl-c"># GET /            # 404</span>
<span class="pl-c"># GET /hello       # 200</span>
<span class="pl-c"># GET /hello/world # 404</span></pre></div>

<p>This last example is not a common usage pattern. It's here only to
illustrate how Cuba can be adapted for different use cases.</p>

<p>If you need this behavior, you can create a helper:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">module</span> <span class="pl-en">TerminalMatcher</span>
  <span class="pl-k">def</span> <span class="pl-en">terminal</span>(<span class="pl-smi">path</span>)
    <span class="pl-sr"><span class="pl-pds">/</span><span class="pl-pse">#{</span><span class="pl-s1">path</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-cce">\/</span>?<span class="pl-cce">\z</span><span class="pl-pds">/</span></span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">TerminalMatcher</span>

<span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on get <span class="pl-k">do</span>
    on terminal(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>) <span class="pl-k">do</span>
      res.write <span class="pl-s"><span class="pl-pds">"</span>hello world<span class="pl-pds">"</span></span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h2>
<a id="security" class="anchor" href="#security" aria-hidden="true"><span class="octicon octicon-link"></span></a>Security</h2>

<p>The most important security consideration is to use <code>https</code> for all
requests. If that's not the case, any attempt to secure the application
could be in vain. The rest of this section assumes <code>https</code> is
enforced.</p>

<p>When building a web application, you need to include a security
layer. Cuba ships with the <code>Cuba::Safe</code> plugin, which applies several
security related headers to prevent attacks like clickjacking and
cross-site scripting, among others. It is not included by default
because there are legitimate uses for plain Cuba (for instance,
when designing an API).</p>

<p>Here's how to include it:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/safe<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">Cuba</span>::<span class="pl-c1">Safe</span></pre></div>

<p>You should also always set a session secret to some undisclosed
value. Keep in mind that the content in the session cookie is
<em>not</em> encrypted.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.use(<span class="pl-c1">Rack</span>::<span class="pl-c1">Session</span>::<span class="pl-c1">Cookie</span>, <span class="pl-c1">:secret</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>__a_very_long_string__<span class="pl-pds">"</span></span>)</pre></div>

<p>In the end, your application should look like this:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/safe<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.use <span class="pl-c1">Rack</span>::<span class="pl-c1">Session</span>::<span class="pl-c1">Cookie</span>, <span class="pl-c1">:secret</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>__a_very_long_string__<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">Cuba</span>::<span class="pl-c1">Safe</span>

<span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on csrf.unsafe? <span class="pl-k">do</span>
    csrf.reset!

    res.status <span class="pl-k">=</span> <span class="pl-c1">403</span>
    res.write(<span class="pl-s"><span class="pl-pds">"</span>Not authorized<span class="pl-pds">"</span></span>)

    halt(res.finish)
  <span class="pl-k">end</span>

  <span class="pl-c"># Now your app is protected against a wide range of attacks.</span>
  ...
<span class="pl-k">end</span></pre></div>

<p>The <code>Cuba::Safe</code> plugin is composed of two modules:</p>

<ul>
<li><code>Cuba::Safe::SecureHeaders</code></li>
<li><code>Cuba::Safe::CSRF</code></li>
</ul>

<p>You can include them individually, but while the modularity is good
for development, it's very common to use them in tandem. As that's
the normal use case, including <code>Cuba::Safe</code> is the preferred way.</p>

<h2>
<a id="cross-site-request-forgery" class="anchor" href="#cross-site-request-forgery" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cross-Site Request Forgery</h2>

<p>The <code>Cuba::Safe::CSRF</code> plugin provides a <code>csrf</code> object with the
following methods:</p>

<ul>
<li>
<code>token</code>: the current security token.</li>
<li>
<code>reset!</code>: forces the token to be recreated.</li>
<li>
<code>safe?</code>: returns <code>true</code> if the request is safe.</li>
<li>
<code>unsafe?</code>: returns <code>true</code> if the request is unsafe.</li>
<li>
<code>form_tag</code>: returns a string with the <code>csrf_token</code> hidden input tag.</li>
<li>
<code>meta_tag</code>: returns a string with the <code>csrf_token</code> meta tag.</li>
</ul>

<p>Here's an example of how to use it:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/safe<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.use <span class="pl-c1">Rack</span>::<span class="pl-c1">Session</span>::<span class="pl-c1">Cookie</span>, <span class="pl-c1">:secret</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>__a_very_long_string__<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">Cuba</span>::<span class="pl-c1">Safe</span>

<span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on csrf.unsafe? <span class="pl-k">do</span>
    csrf.reset!

    res.status <span class="pl-k">=</span> <span class="pl-c1">403</span>
    res.write(<span class="pl-s"><span class="pl-pds">"</span>Not authorized<span class="pl-pds">"</span></span>)

    halt(res.finish)
  <span class="pl-k">end</span>

  <span class="pl-c"># Here comes the rest of your application</span>
  <span class="pl-c"># ...</span>
<span class="pl-k">end</span></pre></div>

<p>You have to include <code>csrf.form_tag</code> in your forms and <code>csrf.meta_tag</code>
among your meta tags. Here's an example that assumes you are using
<code>Cuba::Mote</code> from <code>cuba-contrib</code>:</p>

<div class="highlight highlight-text-html-basic"><pre>&lt;!DOCTYPE html&gt;
&lt;<span class="pl-ent">html</span>&gt;
  &lt;<span class="pl-ent">head</span>&gt;
    {{ app.csrf.meta_tag }}
    ...
  &lt;/<span class="pl-ent">head</span>&gt;
  ...
  &lt;<span class="pl-ent">body</span>&gt;
    &lt;<span class="pl-ent">form</span> <span class="pl-e">action</span>=<span class="pl-s"><span class="pl-pds">"</span>/foo<span class="pl-pds">"</span></span> <span class="pl-e">method</span>=<span class="pl-s"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>&gt;
      {{ app.csrf.form_tag }}
      ...
    &lt;/<span class="pl-ent">form</span>&gt;
  ...
  &lt;/<span class="pl-ent">body</span>&gt;
&lt;/<span class="pl-ent">html</span>&gt;</pre></div>

<h2>
<a id="http-verbs" class="anchor" href="#http-verbs" aria-hidden="true"><span class="octicon octicon-link"></span></a>HTTP Verbs</h2>

<p>There are four matchers defined for HTTP Verbs: <code>get</code>, <code>post</code>, <code>put</code> and
<code>delete</code>. But the world doesn't end there, does it? As you have the whole
request available via the <code>req</code> object, you can query it with helper methods
like <code>req.options?</code> or <code>req.head?</code>, or you can even go to a lower level
and inspect the environment via the <code>env</code> object, and check for example if
<code>env["REQUEST_METHOD"]</code> equals the obscure verb <code>PATCH</code>.</p>

<p>What follows is an example of different ways of saying the same thing:</p>

<div class="highlight highlight-source-ruby"><pre>on env[<span class="pl-s"><span class="pl-pds">"</span>REQUEST_METHOD<span class="pl-pds">"</span></span>] <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>api<span class="pl-pds">"</span></span> <span class="pl-k">do </span>... <span class="pl-k">end</span>

on req.get?, <span class="pl-s"><span class="pl-pds">"</span>api<span class="pl-pds">"</span></span> <span class="pl-k">do </span>... <span class="pl-k">end</span>

on get, <span class="pl-s"><span class="pl-pds">"</span>api<span class="pl-pds">"</span></span> <span class="pl-k">do </span>... <span class="pl-k">end</span></pre></div>

<p>Actually, <code>get</code> is syntax sugar for <code>req.get?</code>, which in turn is syntax sugar
for <code>env["REQUEST_METHOD"] == "GET"</code>.</p>

<h2>
<a id="request-and-response" class="anchor" href="#request-and-response" aria-hidden="true"><span class="octicon octicon-link"></span></a>Request and Response</h2>

<p>You may have noticed we use <code>req</code> and <code>res</code> a lot. Those variables are
instances of <a href="http://www.rubydoc.info/github/rack/rack/Rack/Request">Rack::Request</a> and <code>Cuba::Response</code> respectively, and
<code>Cuba::Response</code> is just an optimized version of
<a href="http://www.rubydoc.info/github/rack/rack/Rack/Response">Rack::Response</a>.</p>

<p>Those objects are helpers for accessing the request and for building
the response. Most of the time, you will just use <code>res.write</code>.</p>

<p>If you want to use custom <code>Request</code> or <code>Response</code> objects, you can
set the new values as follows:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.settings[<span class="pl-c1">:req</span>] <span class="pl-k">=</span> <span class="pl-c1">MyRequest</span>
<span class="pl-c1">Cuba</span>.settings[<span class="pl-c1">:res</span>] <span class="pl-k">=</span> <span class="pl-c1">MyResponse</span></pre></div>

<p>Make sure to provide classes compatible with those from Rack.</p>

<h2>
<a id="captures" class="anchor" href="#captures" aria-hidden="true"><span class="octicon octicon-link"></span></a>Captures</h2>

<p>You may have noticed that some matchers yield a value to the block. The rules
for determining if a matcher will yield a value are simple:</p>

<ol>
<li>Regex captures: <code>"posts/(\\d+)-(.*)"</code> will yield two values, corresponding to each capture.</li>
<li>Placeholders: <code>"users/:id"</code> will yield the value in the position of :id.</li>
<li>Symbols: <code>:foobar</code> will yield if a segment is available.</li>
<li>File extensions: <code>extension("css")</code> will yield the basename of the matched file.</li>
<li>Parameters: <code>param("user")</code> will yield the value of the parameter user, if present.</li>
</ol>

<p>The first case is important because it shows the underlying effect of regex
captures.</p>

<p>In the second case, the substring <code>:id</code> gets replaced by <code>([^\\/]+)</code> and the
string becomes <code>"users/([^\\/]+)"</code> before performing the match, thus it reverts
to the first form we saw.</p>

<p>In the third case, the symbol â€“â€“no matter what it saysâ€“â€“gets replaced
by <code>"([^\\/]+)"</code>, and again we are in presence of case 1.</p>

<p>The fourth case, again, reverts to the basic matcher: it generates the string
<code>"([^\\/]+?)\.#{ext}\\z"</code> before performing the match.</p>

<p>The fifth case is different: it checks if the the parameter supplied is present
in the request (via POST or QUERY_STRING) and it pushes the value as a capture.</p>

<h2>
<a id="composition" class="anchor" href="#composition" aria-hidden="true"><span class="octicon octicon-link"></span></a>Composition</h2>

<p>You can mount a Cuba app, along with middlewares, inside another Cuba app:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">API<span class="pl-e"> &lt; Cuba</span></span>; <span class="pl-k">end</span>

<span class="pl-c1">API</span>.use <span class="pl-c1">SomeMiddleware</span>

<span class="pl-c1">API</span>.define <span class="pl-k">do</span>
  on param(<span class="pl-s"><span class="pl-pds">"</span>url<span class="pl-pds">"</span></span>) <span class="pl-k">do </span>|<span class="pl-smi">url</span>|
    ...
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on <span class="pl-s"><span class="pl-pds">"</span>api<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    run <span class="pl-c1">API</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>If you need to pass information to one sub-app, you can use the
<code>with</code> method and access it with <code>vars</code>:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Platforms<span class="pl-e"> &lt; Cuba</span></span>
  define <span class="pl-k">do</span>
    platform <span class="pl-k">=</span> vars[<span class="pl-c1">:platform</span>]

    on default <span class="pl-k">do</span>
      res.write(platform) <span class="pl-c"># =&gt; "heroku" or "salesforce"</span>
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on <span class="pl-s"><span class="pl-pds">"</span>(heroku|salesforce)<span class="pl-pds">"</span></span> <span class="pl-k">do </span>|<span class="pl-smi">platform</span>|
    with(<span class="pl-c1">platform:</span> platform) <span class="pl-k">do</span>
      run(<span class="pl-c1">Platforms</span>)
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<h2>
<a id="testing" class="anchor" href="#testing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Testing</h2>

<p>Given that Cuba is essentially Rack, it is very easy to test with
<code>Rack::Test</code>, <code>Webrat</code> or <code>Capybara</code>. Cuba's own tests are written
with a combination of <a href="http://github.com/djanowski/cutest">Cutest</a> and <a href="https://github.com/brynary/rack-test">Rack::Test</a>,
and if you want to use the same for your tests it is as easy as
requiring <code>cuba/test</code>:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/test<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>your/app<span class="pl-pds">"</span></span>

scope <span class="pl-k">do</span>
  test <span class="pl-s"><span class="pl-pds">"</span>Homepage<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    get <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>

    assert_equal <span class="pl-s"><span class="pl-pds">"</span>Hello world!<span class="pl-pds">"</span></span>, last_response.body
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>If you prefer to use <a href="http://github.com/jnicklas/capybara">Capybara</a>, instead of requiring
<code>cuba/test</code> you can require <code>cuba/capybara</code>:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/capybara<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>your/app<span class="pl-pds">"</span></span>

scope <span class="pl-k">do</span>
  test <span class="pl-s"><span class="pl-pds">"</span>Homepage<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    visit <span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>

    assert has_content?(<span class="pl-s"><span class="pl-pds">"</span>Hello world!<span class="pl-pds">"</span></span>)
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>To read more about testing, check the documentation for
<a href="http://github.com/djanowski/cutest">Cutest</a>, <a href="https://github.com/brynary/rack-test">Rack::Test</a> and <a href="http://github.com/jnicklas/capybara">Capybara</a>.</p>

<h2>
<a id="settings" class="anchor" href="#settings" aria-hidden="true"><span class="octicon octicon-link"></span></a>Settings</h2>

<p>Each Cuba app can store settings in the <code>Cuba.settings</code> hash. The settings are
inherited if you happen to subclass <code>Cuba</code></p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.settings[<span class="pl-c1">:layout</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>guest<span class="pl-pds">"</span></span>

<span class="pl-k">class</span> <span class="pl-en">Users<span class="pl-e"> &lt; Cuba</span></span>; <span class="pl-k">end</span>
<span class="pl-k">class</span> <span class="pl-en">Admin<span class="pl-e"> &lt; Cuba</span></span>; <span class="pl-k">end</span>

<span class="pl-c1">Admin</span>.settings[<span class="pl-c1">:layout</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span>

assert_equal <span class="pl-s"><span class="pl-pds">"</span>guest<span class="pl-pds">"</span></span>, <span class="pl-c1">Users</span>.settings[<span class="pl-c1">:layout</span>]
assert_equal <span class="pl-s"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span>, <span class="pl-c1">Admin</span>.settings[<span class="pl-c1">:layout</span>]</pre></div>

<p>Feel free to store whatever you find convenient.</p>

<h2>
<a id="rendering" class="anchor" href="#rendering" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rendering</h2>

<p>Cuba includes a plugin called <code>Cuba::Render</code> that provides a couple of helper
methods for rendering templates. This plugin uses <a href="http://github.com/rtomayko/tilt">Tilt</a>, which serves as
an interface to a bunch of different Ruby template engines (ERB, Haml, Sass,
CoffeeScript, etc.), so you can use the template engine of your choice.</p>

<p>To set up <code>Cuba::Render</code>, do:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>cuba/render<span class="pl-pds">"</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">"</span>erb<span class="pl-pds">"</span></span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">Cuba</span>::<span class="pl-c1">Render</span></pre></div>

<p>This example uses ERB, a template engine that comes with Ruby. If you want to
use another template engine, one <a href="https://github.com/rtomayko/tilt/blob/master/docs/TEMPLATES.md">supported by Tilt</a>, you need to
install the required gem and change the <code>template_engine</code> setting as shown
below.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.settings[<span class="pl-c1">:render</span>][<span class="pl-c1">:template_engine</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>haml<span class="pl-pds">"</span></span></pre></div>

<p>The plugin provides three helper methods for rendering templates: <code>partial</code>,
<code>view</code> and <code>render</code>.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.define <span class="pl-k">do</span>
  on <span class="pl-s"><span class="pl-pds">"</span>about<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    <span class="pl-c"># `partial` renders a template called `about.erb` without a layout.</span>
    res.write partial(<span class="pl-s"><span class="pl-pds">"</span>about<span class="pl-pds">"</span></span>)
  <span class="pl-k">end</span>

  on <span class="pl-s"><span class="pl-pds">"</span>home<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    <span class="pl-c"># Opposed to `partial`, `view` renders the same template</span>
    <span class="pl-c"># within a layout called `layout.erb`.</span>
    res.write view(<span class="pl-s"><span class="pl-pds">"</span>about<span class="pl-pds">"</span></span>)
  <span class="pl-k">end</span>

  on <span class="pl-s"><span class="pl-pds">"</span>contact<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    <span class="pl-c"># `render` is a shortcut to `res.write view(...)`</span>
    render(<span class="pl-s"><span class="pl-pds">"</span>contact<span class="pl-pds">"</span></span>)
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>By default, <code>Cuba::Render</code> assumes that all templates are placed in a folder
named <code>views</code> and that they use the proper extension for the chosen template
engine. Also for the <code>view</code> and <code>render</code> methods, it assumes that the layout
template is called <code>layout</code>.</p>

<p>The defaults can be changed through the <code>Cuba.settings</code> method:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Cuba</span>.settings[<span class="pl-c1">:render</span>][<span class="pl-c1">:template_engine</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>haml<span class="pl-pds">"</span></span>
<span class="pl-c1">Cuba</span>.settings[<span class="pl-c1">:render</span>][<span class="pl-c1">:views</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>./views/admin/<span class="pl-pds">"</span></span>
<span class="pl-c1">Cuba</span>.settings[<span class="pl-c1">:render</span>][<span class="pl-c1">:layout</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>admin<span class="pl-pds">"</span></span></pre></div>

<p>NOTE: Cuba doesn't ship with Tilt. You need to install it (<code>gem install tilt</code>).</p>

<h2>
<a id="plugins" class="anchor" href="#plugins" aria-hidden="true"><span class="octicon octicon-link"></span></a>Plugins</h2>

<p>Cuba provides a way to extend its functionality with plugins.</p>

<h3>
<a id="how-to-create-plugins" class="anchor" href="#how-to-create-plugins" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to create plugins</h3>

<p>Authoring your own plugins is pretty straightforward.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">module</span> <span class="pl-en">MyOwnHelper</span>
  <span class="pl-k">def</span> <span class="pl-en">markdown</span>(<span class="pl-smi">str</span>)
    <span class="pl-c1">BlueCloth</span>.<span class="pl-k">new</span>(str).to_html
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">MyOwnHelper</span></pre></div>

<p>That's the simplest kind of plugin you'll write. In fact, that's exactly how
the <code>markdown</code> helper is written in <code>Cuba::TextHelpers</code>.</p>

<p>A more complicated plugin can make use of <code>Cuba.settings</code> to provide default
values. In the following example, note that if the module has a <code>setup</code> method, it will
be called as soon as it is included:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">module</span> <span class="pl-en">Render</span>
  <span class="pl-k">def</span> <span class="pl-en">self.setup</span>(<span class="pl-smi">app</span>)
    app.settings[<span class="pl-c1">:template_engine</span>] <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>erb<span class="pl-pds">"</span></span>
  <span class="pl-k">end</span>

  <span class="pl-k">def</span> <span class="pl-en">partial</span>(<span class="pl-smi">template</span>, <span class="pl-smi">locals</span> <span class="pl-k">=</span> {})
    render(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pse">#{</span><span class="pl-s1">template</span><span class="pl-pse"><span class="pl-s1">}</span></span>.<span class="pl-pse">#{</span><span class="pl-s1">settings[<span class="pl-c1">:template_engine</span>]</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>, locals)
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">Render</span></pre></div>

<p>This sample plugin actually resembles how <code>Cuba::Render</code> works.</p>

<p>Finally, if a module called <code>ClassMethods</code> is present, <code>Cuba</code> will be extended
with it.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">module</span> <span class="pl-en">GetSetter</span>
  <span class="pl-k">module</span> <span class="pl-en">ClassMethods</span>
    <span class="pl-k">def</span> <span class="pl-en">set</span>(<span class="pl-smi">key</span>, <span class="pl-smi">value</span>)
      settings[key] <span class="pl-k">=</span> value
    <span class="pl-k">end</span>

    <span class="pl-k">def</span> <span class="pl-en">get</span>(<span class="pl-smi">key</span>)
      settings[key]
    <span class="pl-k">end</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span>

<span class="pl-c1">Cuba</span>.plugin <span class="pl-c1">GetSetter</span>

<span class="pl-c1">Cuba</span>.set(<span class="pl-c1">:foo</span>, <span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>)

assert_equal <span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>, <span class="pl-c1">Cuba</span>.get(<span class="pl-c1">:foo</span>)
assert_equal <span class="pl-s"><span class="pl-pds">"</span>bar<span class="pl-pds">"</span></span>, <span class="pl-c1">Cuba</span>.settings[<span class="pl-c1">:foo</span>]</pre></div>

<h2>
<a id="contributing" class="anchor" href="#contributing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contributing</h2>

<p>A good first step is to meet us on IRC and discuss ideas. If that's
not possible, you can create an issue explaning the proposed change
and a use case. We pay a lot of attention to use cases, because our
goal is to keep the code base simple. In many cases, the result of
a conversation will be the creation of another tool, instead of the
modification of Cuba itself.</p>

<p>If you want to test Cuba, you may want to use a gemset to isolate
the requirements. We recommend the use of tools like <a href="http://cyx.github.io/dep/">dep</a> and
<a href="http://soveran.github.io/gs/">gs</a>, but you can use similar tools like <a href="https://github.com/tonchis/gst">gst</a> or <a href="https://github.com/educabilia/bs">bs</a>.</p>

<p>The required gems for testing and development are listed in the
<code>.gems</code> file. If you are using <a href="http://cyx.github.io/dep/">dep</a>, you can create a gemset
and run <code>dep install</code>.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/soveran">soveran</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
